<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Dashboard Multi-Fungsi</title>
    
    <style>
        /* ==================== A. CSS DASAR & CONTAINER APP ==================== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-image: url('https://i.postimg.cc/RC2BYrP6/image.png'); 
            background-color: #0c1b33; 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #fff; 
        }

        #main-app-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .app-container-small {
            background: rgba(0, 0, 0, 0.75); 
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5); 
            width: 100%;
            max-width: 420px;
            text-align: center;
            color: #fff; 
        }
        
        .app-container-large {
            background-image: url('https://infomancingduit.com/wp-content/uploads/2024/12/MANCING.png');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            display: flex; 
            min-height: 100vh;
            width: 100%;
            max-width: none; 
            padding: 0;
            margin: 0;
            box-shadow: none;
            border-radius: 0;
            color: #444; 
            justify-content: flex-start;
            align-items: stretch;
        }

        /* Input Group */
        .input-group {
            text-align: left;
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #FFD700; 
        }

        .input-group input, .input-group select { 
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            color: #222; 
            background-color: #f7f7f7;
        }
        
        /* Tombol Umum */
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            transition: background-color 0.3s, transform 0.2s;
        }

        .btn-primary { background-color: #FFD700; color: #0c1b33; } 
        .btn-primary:hover { background-color: #e0b800; transform: translateY(-1px); }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #1e7e34; transform: translateY(-1px); }
        .btn-danger { background-color: #dc3545; color: white; margin-top: 10px; }
        .btn-danger:hover { background-color: #bd2130; }
        .btn-warning { background-color: #ffc107; color: #343a40; } 
        .btn-warning:hover { background-color: #e0a800; }

        .link-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .link-section a {
            color: #7bceff; 
            text-decoration: none;
            font-weight: 500;
            display: block;
            margin-top: 5px;
            transition: color 0.3s;
        }
        
        /* ==================== B. CSS SIDEBAR/MENU ==================== */
        #sidebar {
            width: 250px;
            background-color: rgba(34, 34, 34, 0.95); 
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            position: sticky; 
            height: 100vh;
            color: white;
            z-index: 100;
        }
        #sidebar .logo {
            width: 80%; 
            height: auto;
            margin: 0 auto 15px auto; 
            display: block;
        }
        .menu-item {
            padding: 15px 20px;
            text-decoration: none;
            color: white;
            font-weight: bold;
            border-bottom: 1px solid #333;
            transition: background-color 0.3s, color 0.3s;
            cursor: pointer;
        }
        .menu-item:hover, .menu-item.active {
            background-color: #555;
            color: #FFD700;
        }
        .menu-master-only { display: none; }
        .menu-kapten-hidden { display: block; }
        #dashboard-view .btn-danger { margin-top: auto; border-radius: 0; width: 100%; }

        /* ==================== C. CSS KONTEN UTAMA ==================== */
        #main-container {
            flex-grow: 1;
            padding: 20px;
            box-sizing: border-box;
        }
        .content-panel {
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        h1, h2 { color: #fff; text-shadow: 1px 1px 5px rgba(0,0,0,0.5); }
        #content-cek-ip { background-color: rgba(255, 255, 255, 0.95); }
        #user-info-box {
            background-color: #ffeb3b; 
            color: #333;
            padding: 10px 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
            border: 1px solid #fbc02d;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        textarea#logInput { width: 100%; height: 200px; padding: 10px; box-sizing: border-box; margin-bottom: 10px; }
        button#btn-cek-ip { padding: 10px 20px; background-color: #28a745; color: white; border: none; cursor: pointer; margin-bottom: 20px; }
        #content-cek-ip table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #content-cek-ip th, #content-cek-ip td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #content-cek-ip th { background-color: #e0e6ed; }
        .high-count { background-color: #ffcccc; font-weight: bold; }
        #running-text { padding: 10px 0; margin-bottom: 20px; border-bottom: 2px solid #ccc; }
        .glowing-text {
            font-size: 1.5em; font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 255, 255, 1), 0 0 10px rgba(255, 255, 255, 0.8), 0 0 15px currentColor, 0 0 20px currentColor;
        }
        
        #content-cek-to-crm { background-color: rgba(255, 255, 255, 0.95); }
        #content-cek-to-crm textarea { width: 100%; height: 150px; padding: 10px; box-sizing: border-box; margin-bottom: 10px; }
        #output-to-crm { margin-top: 20px; padding: 15px; border: 1px solid #007bff; background-color: #e6f0ff; border-radius: 8px; text-align: left; }

        #content-pg-soft-calc { background-color: rgba(255, 255, 255, 0.95); }
        #content-pg-soft-calc textarea { width: 100%; height: 150px; padding: 10px; box-sizing: border-box; margin-bottom: 10px; }
        #output-pg-soft { margin-top: 20px; padding: 15px; border: 1px solid #28a745; background-color: #e6ffe6; border-radius: 8px; text-align: left; }

        #content-prediksi-bola { background: rgba(0, 0, 0, 0.85); color: white; }
        #content-prediksi-bola textarea { width: calc(100% - 20px); height: 150px; margin-bottom: 10px; border-radius: 5px; padding: 10px; background: #222; color: #eee; border: 1px solid #555; }

        #content-kelola-user { background-color: rgba(255, 255, 255, 0.95); }
        #user-table { margin-top: 20px; width: 100%; border-collapse: collapse; }
        #user-table th, #user-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }

        #content-history-ip { background-color: rgba(255, 255, 255, 0.95); }
        #history-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    </style>
</head>
<body>
    
    <div id="main-app-container">

        <section id="login-view" class="app-container-small" style="display: none;">
            <h1>üëã Selamat Datang</h1>
            <p>Silakan masuk ke akun Anda.</p>
            <form id="login-form">
                <div class="input-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" required>
                </div>
                <div class="input-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Masuk</button>
            </form>
            <div class="link-section">
                <p>Belum punya akun?</p>
                <a href="#" onclick="showView('register-view'); return false;">Register Akun Baru</a>
            </div>
        </section>

        <section id="register-view" class="app-container-small" style="display: none;">
            <h1>‚úçÔ∏è Daftar Akun Baru</h1>
            <p>Isi detail Anda untuk membuat akun.</p>
            <form id="register-form">
                <div class="input-group">
                    <label for="reg-username">Username:</label>
                    <input type="text" id="reg-username" required>
                </div>
                <div class="input-group">
                    <label for="reg-password">Password:</label>
                    <input type="password" id="reg-password" required>
                </div>
                <button type="submit" class="btn btn-success">Daftar Sekarang</button>
            </form>
            <div class="link-section">
                <p>Sudah punya akun?</p>
                <a href="#" onclick="showView('login-view'); return false;">Kembali ke Login</a>
            </div>
        </section>
        
        <section id="dashboard-view" class="app-container-large" style="display: none;">
            <div id="sidebar">
                <img src="https://i.postimg.cc/8PMP5890/logo.png" alt="Logo Mancing Duit" class="logo">
                <a href="#" class="menu-item active menu-kapten-hidden" data-content="cek-ip" id="menu-cek-ip" onclick="switchDashboardContent('cek-ip', this); return false;">üîç Cek IP</a>
                <a href="#" class="menu-item" data-content="cek-to-crm" id="menu-cek-to-crm" onclick="switchDashboardContent('cek-to-crm', this); return false;">üí≤ CEK TO CRM</a>
                <a href="#" class="menu-item" data-content="pg-soft-calc" id="menu-pg-soft-calc" onclick="switchDashboardContent('pg-soft-calc', this); return false;">üé∞ HITUNG KEMENANGAN PG SOFT</a>
                <a href="#" class="menu-item menu-kapten-hidden" data-content="prediksi-bola" id="menu-prediksi-bola" onclick="switchDashboardContent('prediksi-bola', this); return false;">‚öΩ PREDIKSI BOLA</a>
                <a href="#" class="menu-item menu-master-only" data-content="kelola-user" id="menu-kelola-user" onclick="switchDashboardContent('kelola-user', this); return false;">üë§ Kelola User</a> 
                <button id="logout-button" class="btn btn-danger" onclick="handleLogout(); return false;">Keluar (Logout)</button>
            </div>
            
            <div id="main-container">
                <div id="content-cek-ip" class="content-panel">
                    <div id="user-info-box"></div> 
                    <div id="running-text">
                        <marquee behavior="scroll" direction="left" scrollamount="10">
                            <span class="glowing-text">
                                <span style="color: #FF0000;">C</span> <span style="color: #FF00FF;">E</span> <span style="color: #00FFFF;">K</span> <span style="color: #00FF00;">&nbsp;IP</span>...
                            </span>
                        </marquee>
                    </div>
                    <h1>üîç Dashboard Analisis IP Login</h1>
                    <textarea id="logInput" placeholder="Tempelkan data Anda di sini..."></textarea>
                    <button onclick="processData()" id="btn-cek-ip">Klik Disini</button>
                    <div id="results"></div>
                </div>

                <div id="content-cek-to-crm" class="content-panel" style="display: none;">
                    <h2>üí≤ CEK TOTAL PERTARUHAN (TO)</h2>
                    <textarea id="toInput" placeholder="Tempelkan data log transaksi..."></textarea>
                    <button class="btn btn-primary" onclick="processToData()">PROSES & HITUNG TOTAL TO</button>
                    <div id="output-to-crm"><pre id="crmOutput"></pre></div>
                </div>

                <div id="content-pg-soft-calc" class="content-panel" style="display: none;">
                    <h2>üé∞ HITUNG TOTAL PEMBAYARAN PG SOFT</h2>
                    <textarea id="pgSoftInput"></textarea>
                    <button class="btn btn-primary" onclick="processPgSoftData()">HITUNG</button>
                    <div id="output-pg-soft"><pre id="pgSoftOutput"></pre></div>
                </div>

                <div id="content-prediksi-bola" class="content-panel" style="display: none;">
                    <h2>‚öΩ PREDIKSI BOLA</h2>
                    <textarea id="input"></textarea><br>
                    <button onclick="generateTable()">GENERATE</button>
                    <div id="output"></div>
                    <textarea id="htmlOutput" readonly></textarea>
                </div>

                <div id="content-kelola-user" class="content-panel" style="display: none;">
                    <h2>üë§ Kelola User</h2>
                    <div id="user-list">
                        <table id="user-table">
                            <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Status</th><th>Aksi</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        const BASE_API_URL = 'https://sheetdb.io/api/v1/u3plihngfze98'; 
        let users = []; 
        let currentUsername = null;
        let currentUserRole = null; 

        // 1. FUNGSI FETCH DATA (Sekarang bersifat background process)
        async function fetchUsers() {
            try {
                const response = await fetch(BASE_API_URL);
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                users = data.map(user => ({
                    id: user.username, 
                    username: user.username,
                    email: user.email || 'default@email.com',
                    password: user.password,
                    role: user.role,
                    status: user.status || 'PENDING'
                }));
                
                // Jika sedang di halaman Kelola User, update tabelnya otomatis setelah data masuk
                if(document.getElementById('content-kelola-user').style.display === 'block') {
                    renderUserTable();
                }
                console.log("Database disinkronkan dari background.");
            } catch (error) {
                console.error('Fetch Users Error:', error);
            }
        }

        // 2. INISIALISASI HALAMAN (PERBAIKAN UTAMA: Langsung Muncul)
        document.addEventListener('DOMContentLoaded', () => {
            // LANGKAH 1: Cek Sesi Lokal (Instant)
            const storedUser = localStorage.getItem('loggedInUser');
            const storedRole = localStorage.getItem('loggedInRole');

            if (storedUser && storedRole) {
                currentUsername = storedUser;
                currentUserRole = storedRole;
                
                // Langsung tampilkan dashboard tanpa nunggu API
                showView('dashboard-view');
                
                let defaultContentId = (storedRole === 'KAPTEN') ? 'cek-to-crm' : 'cek-ip';
                let defaultMenuElement = document.getElementById(`menu-${defaultContentId}`);
                if (defaultMenuElement) {
                   switchDashboardContent(defaultContentId, defaultMenuElement);
                }
                
                // LANGKAH 2: Ambil data terbaru di background agar data 'users' sinkron
                fetchUsers(); 
            } else {
                showView('login-view');
                fetchUsers(); 
            }
            
            // Event Listeners
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
        });

        // 3. FUNGSI LOGIN (Harus nunggu fetchUsers selesai jika user baru)
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Pastikan kita punya data user terbaru sebelum login
            if (users.length === 0) await fetchUsers(); 
            
            const user = users.find(u => u.username === username && u.password === password);

            if (!user) {
                alert('Login gagal! Username atau Password salah.');
                return;
            }
            
            if (user.status !== 'APPROVED') {
                alert('Akun Anda belum disetujui Master.');
                return;
            }
            
            currentUsername = user.username;
            currentUserRole = user.role;
            localStorage.setItem('loggedInUser', currentUsername);
            localStorage.setItem('loggedInRole', currentUserRole);

            showView('dashboard-view');
            let defaultId = (user.role === 'KAPTEN') ? 'cek-to-crm' : 'cek-ip';
            switchDashboardContent(defaultId, document.getElementById(`menu-${defaultId}`));
        }

        // --- FUNGSI UTILITY DASHBOARD ---

        function showView(viewId) {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('register-view').style.display = 'none';
            document.getElementById('dashboard-view').style.display = 'none';

            if (viewId === 'dashboard-view') {
                document.getElementById('main-app-container').className = 'app-container-large';
                updateSidebarVisibility(currentUserRole);
                document.getElementById(viewId).style.display = 'flex'; 
            } else {
                document.getElementById('main-app-container').className = 'app-container-small';
                document.getElementById(viewId).style.display = 'block'; 
            }
        }

        function updateSidebarVisibility(role) {
            document.querySelectorAll('.menu-master-only').forEach(m => m.style.display = (role === 'MASTER') ? 'block' : 'none');
            document.querySelectorAll('.menu-kapten-hidden').forEach(m => m.style.display = (role === 'KAPTEN') ? 'none' : 'block');
        }

        function switchDashboardContent(contentId, clickedElement) {
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            if (clickedElement) clickedElement.classList.add('active');
            document.querySelectorAll('.content-panel').forEach(p => p.style.display = 'none');
            const target = document.getElementById('content-' + contentId);
            if (target) target.style.display = 'block';
            
            if (contentId === 'cek-ip') updateUserInfoBox(currentUsername);
            if (contentId === 'kelola-user') renderUserTable();
        }

        function updateUserInfoBox(username) {
            const box = document.getElementById('user-info-box');
            if (box) box.innerHTML = username ? `Anda login sebagai: <strong>${username}</strong>` : '';
        }

        function handleLogout() {
            localStorage.clear();
            location.reload(); // Refresh total untuk reset state
        }

        // (Fungsi Logika Bisnis Cek IP, TO, PG Soft, dll tetap sama dengan kode Anda sebelumnya)
        // Saya tidak menghapus logika internalnya, hanya memperbaiki alur loading-nya.

        async function handleRegister(event) {
            event.preventDefault();
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const dataToSend = { data: { username, password, email: 'user@default.com', role: 'CS', status: 'PENDING' } };
            try {
                const res = await fetch(BASE_API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dataToSend)});
                if (res.ok) { alert('Berhasil! Tunggu ACC.'); showView('login-view'); fetchUsers(); }
            } catch (e) { alert('Gagal Register.'); }
        }

        function renderUserTable() {
            const tbody = document.getElementById('user-table').querySelector('tbody');
            tbody.innerHTML = '';
            users.forEach(u => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${u.username}</td><td>${u.email}</td><td>${u.role}</td><td>${u.status}</td><td>-</td>`;
            });
        }
        
    </script>
</body>
</html>
