<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Dashboard Multi-Fungsi</title>
    
    <style>
        /* ==================== A. CSS DASAR & CONTAINER APP ==================== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            /* Mengganti background polos dengan biru bercorak naga */
            background-image: url('https://i.postimg.cc/RC2BYrP6/image.png'); /* Ganti dengan URL gambar naga biru Anda */
            background-color: #0c1b33; /* Dark blue fallback */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            /* End Latar belakang baru */
            
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #fff; /* Teks default jadi putih agar terbaca di background gelap */
        }

        #main-app-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .app-container-small {
            /* Ubah kotak login menjadi semi-transparan gelap agar corak terlihat */
            background: rgba(0, 0, 0, 0.75); 
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5); /* Shadow lebih gelap */
            width: 100%;
            max-width: 420px;
            text-align: center;
            color: #fff; /* Pastikan teks di dalam kotak putih */
        }
        
        .app-container-large {
            background-image: url('https://infomancingduit.com/wp-content/uploads/2024/12/MANCING.png');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            display: flex; 
            min-height: 100vh;
            width: 100%;
            max-width: none; 
            padding: 0;
            margin: 0;
            box-shadow: none;
            border-radius: 0;
            color: #444; /* Dashboard tetap menggunakan warna default untuk teks utama */
            justify-content: flex-start;
            align-items: stretch;
        }

        /* Input Group */
        .input-group {
            text-align: left;
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            /* color: #444; */ /* Ganti warna label */
            color: #FFD700; /* Gold untuk kontras */
        }

        .input-group input, .input-group select { /* Tambah select */
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            color: #222; /* Warna teks input agar tetap terlihat */
            background-color: #f7f7f7;
        }
        
        /* Tombol Umum */
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            transition: background-color 0.3s, transform 0.2s;
        }

        /* Tombol Masuk */
        .btn-primary { background-color: #FFD700; color: #0c1b33; } /* Gold button, dark text */
        .btn-primary:hover { background-color: #e0b800; transform: translateY(-1px); }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #1e7e34; transform: translateY(-1px); }
        .btn-danger { background-color: #dc3545; color: white; margin-top: 10px; }
        .btn-danger:hover { background-color: #bd2130; }
        .btn-warning { background-color: #ffc107; color: #343a40; } /* Untuk Approve */
        .btn-warning:hover { background-color: #e0a800; }

        /* Bagian Navigasi/Link Login/Register */
        .link-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .link-section a {
            color: #7bceff; /* Light blue link */
            text-decoration: none;
            font-weight: 500;
            display: block;
            margin-top: 5px;
            transition: color 0.3s;
        }
        
        /* ==================== B. CSS SIDEBAR/MENU (Dashboard) ==================== */
        #sidebar {
            width: 250px;
            background-color: rgba(34, 34, 34, 0.95); 
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            position: sticky; 
            height: 100vh;
            color: white;
            z-index: 100;
        }
        #sidebar .logo {
            width: 80%; 
            height: auto;
            margin: 0 auto 15px auto; 
            display: block;
        }
        .menu-item {
            padding: 15px 20px;
            text-decoration: none;
            color: white;
            font-weight: bold;
            border-bottom: 1px solid #333;
            transition: background-color 0.3s, color 0.3s;
            cursor: pointer;
        }
        .menu-item:hover, .menu-item.active {
            background-color: #555;
            color: #FFD700;
        }
        /* Role Master Only Menu */
        .menu-master-only {
            display: none; /* Default hidden, controlled by JS */
        }
        /* Role Kapten Hidden Menu (Cek IP, Prediksi Bola) */
        .menu-kapten-hidden {
            display: block; /* Default visible, controlled by JS */
        }
        #dashboard-view .btn-danger {
            margin-top: auto;
            border-radius: 0;
            width: 100%;
        }

        /* ==================== C. CSS KONTEN UTAMA (Dashboard) ==================== */
        #main-container {
            flex-grow: 1;
            padding: 20px;
            box-sizing: border-box;
        }
        .content-panel {
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        /* Ubah warna header agar terlihat di background gelap login/register */
        h1, h2 { color: #fff; text-shadow: 1px 1px 5px rgba(0,0,0,0.5); }
        
        /* Cek IP Specific CSS */
        #content-cek-ip { background-color: rgba(255, 255, 255, 0.95); }
        
        /* CSS BARU UNTUK INFO USER */
        #user-info-box {
            background-color: #ffeb3b; /* Kuning terang */
            color: #333;
            padding: 10px 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
            border: 1px solid #fbc02d;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        textarea#logInput { width: 100%; height: 200px; padding: 10px; box-sizing: border-box; margin-bottom: 10px; }
        button#btn-cek-ip { padding: 10px 20px; background-color: #28a745; color: white; border: none; cursor: pointer; margin-bottom: 20px; }
        #content-cek-ip table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #content-cek-ip th, #content-cek-ip td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #content-cek-ip th { background-color: #e0e6ed; }
        .high-count { background-color: #ffcccc; font-weight: bold; }
        #running-text { padding: 10px 0; margin-bottom: 20px; border-bottom: 2px solid #ccc; }
        .glowing-text {
            font-size: 1.5em; font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 255, 255, 1), 0 0 10px rgba(255, 255, 255, 0.8), 0 0 15px currentColor, 0 0 20px currentColor;
        }
        
        /* CEK TO CRM Specific CSS */
        #content-cek-to-crm { background-color: rgba(255, 255, 255, 0.95); }
        #content-cek-to-crm textarea { width: 100%; height: 150px; padding: 10px; box-sizing: border-box; margin-bottom: 10px; }
        #output-to-crm { 
            margin-top: 20px; 
            padding: 15px; 
            border: 1px solid #007bff; 
            background-color: #e6f0ff; 
            border-radius: 8px; 
            text-align: left;
        }
        #output-to-crm h3 { margin-top: 0; color: #007bff; }

        /* PG Soft Calc Specific CSS */
        #content-pg-soft-calc { background-color: rgba(255, 255, 255, 0.95); }
        #content-pg-soft-calc textarea { width: 100%; height: 150px; padding: 10px; box-sizing: border-box; margin-bottom: 10px; }
        #output-pg-soft { 
            margin-top: 20px; 
            padding: 15px; 
            border: 1px solid #28a745; /* Success Green border */
            background-color: #e6ffe6; 
            border-radius: 8px; 
            text-align: left;
        }
        #output-pg-soft h3 { margin-top: 0; color: #28a745; }


        /* Prediksi Bola Specific CSS */
        #content-prediksi-bola { background: rgba(0, 0, 0, 0.85); color: white; }
        #content-prediksi-bola h2 { color: #FFD700; text-shadow: 0 0 8px #FFD700, 0 0 15px #FFD700; margin-bottom: 20px; }
        #content-prediksi-bola textarea {
            width: calc(100% - 20px); height: 150px; margin-bottom: 10px; border-radius: 5px; padding: 10px; resize: vertical;
            background: #222; color: #eee; border: 1px solid #555;
        }
        #content-prediksi-bola button {
            background: #FFD700; color: black; border: none; padding: 10px 25px; margin: 5px; cursor: pointer;
            font-weight: bold; border-radius: 5px; transition: background 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 0 5px #FFD700;
        }
        #htmlOutput { height: 300px; background: #111; color: #0f0; font-family: 'Consolas', 'Monaco', monospace; border: 1px solid #333; }
        .match-block { background: #1a1a1a; color: white; border-radius: 5px; margin: 25px auto; padding: 0; width: 100%; max-width: 700px; overflow: hidden; box-shadow: 0 0 15px rgba(0,0,0,0.7); }
        .match-block .league-title { background: #000000; color: #f6ff00; padding: 10px 15px; margin: 0; text-align: center; font-size: 1em; font-weight: bold; text-transform: uppercase; text-shadow: 0 0 6px #FFFF00; }
        .match-block thead th { background: #fffb00; color: #000; font-weight: bold; padding: 8px 12px; border: 1px solid #444; text-align: center; }
        .match-block tbody td { background: #111; color: #fff; padding: 8px 12px; border: 1px solid #444; text-align: center; }

        /* Kelola User Specific CSS */
        #content-kelola-user { background-color: rgba(255, 255, 255, 0.95); }
        #user-form { display: flex; flex-direction: column; gap: 10px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 20px; }
        #user-form input, #user-form select { padding: 10px; border-radius: 5px; border: 1px solid #ddd; }
        #user-form button { width: auto; margin-top: 5px; padding: 10px 20px; }
        #user-table { margin-top: 20px; width: 100%; border-collapse: collapse; }
        #user-table th, #user-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        #user-table th { background-color: #e0e6ed; }
        #user-table td button { width: auto; padding: 5px 10px; margin: 2px; font-size: 12px; }
        .status-pending { color: orange; font-weight: bold; }
        .status-approved { color: green; font-weight: bold; }
        .status-rejected { color: red; font-weight: bold; }

        /* History IP Specific CSS */
        #content-history-ip { background-color: rgba(255, 255, 255, 0.95); }
        #history-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #history-table th, #history-table td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 0.9em; }
        #history-table th { background-color: #ffeb3b; } /* Warna Kuning untuk Master */
        .history-raw-data { max-height: 100px; overflow: auto; background-color: #f8f8f8; padding: 5px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; word-break: break-all; }

    </style>
</head>
<body>
    
    <div id="main-app-container">

        <section id="login-view" class="app-container-small" style="display: none;">
            <h1>üëã Selamat Datang</h1>
            <p>Silakan masuk ke akun Anda.</p>
            <form id="login-form">
                <div class="input-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" required>
                </div>
                <div class="input-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Masuk</button>
            </form>
            <div class="link-section">
                <p>Belum punya akun?</p>
                <a href="#" onclick="showView('register-view'); return false;">Register Akun Baru</a>
            </div>
        </section>

        <section id="register-view" class="app-container-small" style="display: none;">
            <h1>‚úçÔ∏è Daftar Akun Baru</h1>
            <p>Isi detail Anda untuk membuat akun.</p>
            <form id="register-form">
                <div class="input-group">
                    <label for="reg-username">Username:</label>
                    <input type="text" id="reg-username" required>
                </div>
                
                <div class="input-group">
                    <label for="reg-password">Password:</label>
                    <input type="password" id="reg-password" required>
                </div>
                <button type="submit" class="btn btn-success">Daftar Sekarang</button>
            </form>
            <div class="link-section">
                <p>Sudah punya akun?</p>
                <a href="#" onclick="showView('login-view'); return false;">Kembali ke Login</a>
            </div>
        </section>
        
        <section id="dashboard-view" class="app-container-large" style="display: none;">
            
            <div id="sidebar">
                <img src="https://i.postimg.cc/8PMP5890/logo.png" alt="Logo Mancing Duit" class="logo">
                <a href="#" class="menu-item active menu-kapten-hidden" data-content="cek-ip" id="menu-cek-ip" onclick="switchDashboardContent('cek-ip', this); return false;">üîç Cek IP</a>
                
                <a href="#" class="menu-item" data-content="cek-to-crm" id="menu-cek-to-crm" onclick="switchDashboardContent('cek-to-crm', this); return false;">üí≤ CEK TO CRM</a>
                
                <a href="#" class="menu-item" data-content="pg-soft-calc" id="menu-pg-soft-calc" onclick="switchDashboardContent('pg-soft-calc', this); return false;">üé∞ HITUNG KEMENANGAN PG SOFT</a>
                
                <a href="#" class="menu-item menu-kapten-hidden" data-content="prediksi-bola" id="menu-prediksi-bola" onclick="switchDashboardContent('prediksi-bola', this); return false;">‚öΩ PREDIKSI BOLA</a>
                
                <a href="#" class="menu-item menu-master-only" data-content="kelola-user" id="menu-kelola-user" onclick="switchDashboardContent('kelola-user', this); return false;">üë§ Kelola User</a> 
                <button id="logout-button" class="btn btn-danger" onclick="handleLogout(); return false;">Keluar (Logout)</button>
            </div>
            
            <div id="main-container">
                
                <div id="content-cek-ip" class="content-panel">
                    <div id="user-info-box"></div> 
                    <div id="running-text">
                        <marquee behavior="scroll" direction="left" scrollamount="10">
                            <span class="glowing-text">
                                <span style="color: #FF0000;">C</span> <span style="color: #FF00FF;">E</span> <span style="color: #00FFFF;">K</span> <span style="color: #00FF00;">&nbsp;IP</span> <span style="color: #0000FF;">&nbsp;S</span> <span style="color: #4B0082;">E</span> <span style="color: #FF0000;">T</span> <span style="color: #FF00FF;">I</span> <span style="color: #00FFFF;">A</span> <span style="color: #00FF00;">P</span> <span style="color: #0000FF;">&nbsp;1</span> <span style="color: #4B0082;">&nbsp;J</span> <span style="color: #FF0000;">A</span> <span style="color: #FF00FF;">M</span> <span style="color: #00FFFF;">&nbsp;S</span> <span style="color: #00FF00;">E</span> <span style="color: #0000FF;">K</span> <span style="color: #4B0082;">A</span> <span style="color: #FF0000;">L</span> <span style="color: #FF00FF;">I</span> 
                            </span>
                        </marquee>
                    </div>
                    <h1>üîç Dashboard Analisis IP Login</h1>
                    <p>‚úÖTempelkan data Anda di bawah ini. Tekan **F5** untuk membersihkan input.</p>
                    <textarea id="logInput" placeholder="Tempelkan data Anda di sini (misal: 'UserID1    2024-12-09 10:00:00    192.168.1.1')..." autocomplete="off"></textarea>
                    <button onclick="processData()" id="btn-cek-ip">Klik Disini</button>
                    <div id="results">
                        <p>Tempelkan data Anda dan tekan "Klik Disini".</p>
                    </div>
                </div>
                
                <div id="content-cek-to-crm" class="content-panel" style="display: none;">
                    <h2>üí≤ CEK TOTAL PERTARUHAN (TO)</h2>
                    <p>‚úÖ Tempelkan data transaksi log (semua baris) di sini untuk menghitung Total Nominal Pertaruhan (TO).</p>
                    <textarea id="toInput" placeholder="Tempelkan data log transaksi Anda di sini. Hanya transaksi 'Pertaruhan' yang akan dihitung..." autocomplete="off"></textarea>
                    <button class="btn btn-primary" onclick="processToData()">PROSES & HITUNG TOTAL TO</button>
                    <div id="output-to-crm">
                        <h3>üìã Hasil Total Turn Over (TO):</h3>
                        <pre id="crmOutput" style="white-space: pre-wrap; font-family: monospace;">Total TO akan muncul di sini setelah Anda memproses data log.</pre>
                    </div>
                </div>

                <div id="content-pg-soft-calc" class="content-panel" style="display: none;">
                    <h2>üé∞ HITUNG TOTAL PEMBAYARAN PG SOFT</h2>
                    <p>‚úÖ Tempelkan data log PG Soft (semua baris) di sini. **Hanya menghitung total nominal pada baris 'Pembayaran'.**</p>
                    <textarea id="pgSoftInput" placeholder="Tempelkan data log transaksi PG Soft Anda di sini. Nominal 'Pembayaran' yang akan dijumlahkan." autocomplete="off"></textarea>
                    <button class="btn btn-primary" onclick="processPgSoftData()">PROSES & HITUNG TOTAL PEMBAYARAN</button>
                    
                    <div id="output-pg-soft">
                        <h3>üìã Hasil Total Pembayaran (Win/Payout)</h3>
                        <pre id="pgSoftOutput" style="white-space: pre-wrap; font-family: monospace;">Total Pembayaran akan muncul di sini setelah Anda memproses data log.</pre>
                        
                        <hr style="border-top: 2px dashed #ccc; margin: 20px 0;">

                        <h3>‚ú® HITUNG KEMENANGAN BERSIH (NETT WIN)</h3>
                        <p>1. Pastikan Anda sudah memproses data Pembayaran di atas.</p>
                        <p>2. Tempelkan total nominal Normal Spin (Bukan Bet/TO) di bawah ini:</p>
                        
                        <input type="text" id="normalSpinInput" placeholder="Contoh: 1,721,600" style="margin-bottom: 10px; text-align: right;">

                        <button class="btn btn-success" onclick="calculateNetWin()">HITUNG KEMENANGAN BERSIH</button>
                        
                        <pre id="netWinOutput" style="white-space: pre-wrap; font-family: monospace; margin-top: 15px; padding: 10px; background-color: #f7fff7; border: 1px solid #28a745;">Hasil Kemenangan Bersih akan tampil di sini (Pembayaran - Normal Spin).</pre>
                    </div>
                    </div>

                <div id="content-prediksi-bola" class="content-panel" style="display: none;">
                    <h2>‚öΩ PREDIKSI BOLA</h2>
                    <p>Masukkan data pertandingan di sini:</p>
                    <textarea id="input" placeholder="Masukkan pertandingan di sini (pisahkan dengan baris baru untuk liga baru)..." autocomplete="off"></textarea><br>
                    <button onclick="generateTable()">GENERATE TABEL</button>
                    <button onclick="copyHTML()">COPY SEMUA HTML</button>
                    <div id="output"></div>
                    <h3 class="hasil-html">üìã Hasil HTML Disini:</h3>
                    <textarea id="htmlOutput" readonly autocomplete="off"></textarea>
                </div>

                <div id="content-history-ip" class="content-panel" style="display: none;">
                    <h2>üìú History Pengecekan IP Staff</h2>
                    <p>Riwayat pengecekan IP yang dilakukan oleh semua staf (CS/Kapten) dan Master.</p>
                    <button class="btn btn-danger" style="width: auto; margin-top: 5px;" onclick="clearHistory()">‚ùå Hapus Semua Riwayat</button>
                    <div id="history-list">
                        <table id="history-table">
                            <thead>
                                <tr>
                                    <th>Waktu Cek</th>
                                    <th>Username Staf</th>
                                    <th>Jumlah IP Unik</th>
                                    <th>IP Terbanyak (Hit)</th>
                                    <th>Data Mentah</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="content-kelola-user" class="content-panel" style="display: none;">
                    <h2>üë§ Kelola User</h2>
                    <p>Fungsi untuk menambah, mengedit, atau menghapus data user.</p>

                    <form id="user-form">
                        <input type="hidden" id="user-username-hidden"> <input type="text" id="user-username" placeholder="Username" required>
                        <input type="text" id="user-email" placeholder="Email" required>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label for="user-role" style="margin-bottom: 0;">Role:</label>
                            <select id="user-role" required>
                                <option value="CS">CS</option>
                                <option value="KAPTEN">KAPTEN</option>
                                <option value="MASTER">MASTER</option>
                            </select>
                        </div>
                        <input type="password" id="user-password" placeholder="Password (Kosongkan jika tidak diubah)">
                        <button type="submit" id="submit-user-btn" class="btn-primary">Tambah User</button>
                        <button type="button" id="cancel-edit-btn" class="btn-danger" style="display:none; width: auto;" onclick="resetUserForm()">Batal Edit</button>
                    </form>

                    <div id="user-list">
                        <h3>Daftar User Saat Ini</h3>
                        <table id="user-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th> <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
        </section>

    </div>

    <script>
        // ======================================
        // C. KONEKSI API TERPUSAT (SheetDB) - PERUBAHAN UTAMA DI SINI
        // ======================================
        
        // TEMPELKAN LINK SHEETDB ANDA DI SINI
        const BASE_API_URL = 'https://sheetdb.io/api/v1/u3plihngfze98'; 

        const mainAppContainer = document.getElementById('main-app-container');
        const THRESHOLD = 3; 
        
        let currentUsername = null;
        let currentUserRole = null; 
        let lastTotalPayout = 0; 
        
        // Inisiasi array kosong. Akan diisi oleh fetchUsers()
        let users = []; 
        let nextUserId = 1; 

        // FUNGSI UTAMA: Mengambil semua data user dari SheetDB
        async function fetchUsers() {
            try {
                const response = await fetch(BASE_API_URL);
                if (!response.ok) {
                    throw new Error('Gagal mengambil data user dari SheetDB. Cek status Sheets Anda.');
                }
                const data = await response.json();
                
                // PENTING: Map dan parse data dari SheetDB. 
                users = data.map(user => ({
                    id: user.username, 
                    username: user.username,
                    email: user.email || 'default@email.com',
                    password: user.password,
                    role: user.role,
                    status: user.status || 'PENDING',
                    // Pastikan properti ip_history ada (walaupun hanya string '[]' dari Sheets)
                    ip_history: user.ip_history ? JSON.parse(user.ip_history) : []
                }));
                
                console.log("Data user berhasil di-fetch dan di-parse:", users);
                return users;
            } catch (error) {
                console.error('Fetch Users Error:', error);
                alert('Gagal terhubung ke database terpusat. Pastikan Google Sheet dan SheetDB Anda aktif dan sudah di-Share.');
                return [];
            }
        }
        
        // Fungsi Helper untuk Update Status/Data User di SheetDB
        async function updateUserOnSheetDB(username, updateData) {
            // SheetDB menggunakan /username/:value untuk mencari dan mengupdate
            const searchUrl = `${BASE_API_URL}/username/${username}`; 
            
            const dataToSend = {
                data: updateData
            };
            
            try {
                const response = await fetch(searchUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend)
                });

                if (response.ok) {
                    // Jika berhasil, muat ulang data global agar data yang ditampilkan selalu baru
                    await fetchUsers(); 
                    return true;
                } else {
                    const errorData = await response.json().catch(() => ({ message: 'Error server saat update.' }));
                    alert(`Gagal update user ${username}. Pesan: ${errorData.message}`);
                    return false;
                }
            } catch (error) {
                console.error('Error Update:', error);
                alert('Gagal terhubung ke SheetDB saat update.');
                return false;
            }
        }


        // ======================================
        // A. Fungsi Navigasi & Utility
        // ======================================

        function showView(viewId) {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('register-view').style.display = 'none';
            document.getElementById('dashboard-view').style.display = 'none';

            if (viewId === 'dashboard-view') {
                mainAppContainer.className = 'app-container-large';
                updateSidebarVisibility(currentUserRole); // Panggil untuk update menu
                document.getElementById(viewId).style.display = 'flex'; 
            } else {
                mainAppContainer.className = 'app-container-small';
                document.getElementById(viewId).style.display = 'block'; 
                // NOTE: Session direset hanya saat handleLogout dipanggil, bukan di sini
            }
        }
        
        function updateSidebarVisibility(role) {
            // 1. Tangani menu hanya untuk MASTER (Kelola User)
            const masterMenus = document.querySelectorAll('.menu-master-only');
            masterMenus.forEach(menu => {
                menu.style.display = (role === 'MASTER') ? 'block' : 'none';
            });

            // 2. Tangani menu yang disembunyikan untuk KAPTEN (Cek IP & Prediksi Bola)
            const kaptenHiddenMenus = document.querySelectorAll('.menu-kapten-hidden');
            const kaptenHiddenVisibility = (role === 'KAPTEN') ? 'none' : 'block'; 
            kaptenHiddenMenus.forEach(menu => {
                menu.style.display = kaptenHiddenVisibility;
            });
            
            // 3. (PENTING) Jika role KAPTEN, pastikan konten default yang aktif adalah yang visible.
            if (role === 'KAPTEN') {
                const activeMenu = document.querySelector('.menu-item.active');
                if (activeMenu && (activeMenu.id === 'menu-cek-ip' || activeMenu.id === 'menu-prediksi-bola')) {
                     // Pindah ke menu 'CEK TO CRM' sebagai default Kapten
                     const defaultMenu = document.getElementById('menu-cek-to-crm');
                     if (defaultMenu) {
                         switchDashboardContent('cek-to-crm', defaultMenu);
                     }
                }
            }
        }

        // FUNGSI BARU: Update kotak info user - DISESUAIKAN UNTUK HANYA MENAMPILkan USERNAME
        function updateUserInfoBox(username) {
            const box = document.getElementById('user-info-box');
            if (box && username) {
                box.innerHTML = `Anda login sebagai: <strong><span style="color: #007bff;">${username}</span></strong>`;
            } else if (box) {
                box.innerHTML = ''; // Kosongkan box di menu lain
            }
        }

        function switchDashboardContent(contentId, clickedElement) {
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            if (clickedElement) clickedElement.classList.add('active');

            document.querySelectorAll('.content-panel').forEach(p => p.style.display = 'none');
            const targetId = 'content-' + contentId;
            const targetPanel = document.getElementById(targetId);
            if (targetPanel) {
                targetPanel.style.display = 'block';
            }

            // Panggil fungsi update info box saat berpindah ke Cek IP
            if (contentId === 'cek-ip') {
                 updateUserInfoBox(currentUsername); 
            } else {
                 updateUserInfoBox(null); // Kosongkan box di menu lain
            }
            
            if (contentId === 'kelola-user') {
                renderUserTable();
            } else if (contentId === 'history-ip') { 
                renderHistoryTable();
            }
        }

        function handleLogout() {
            // HAPUS SESSION DARI LOCALSTORAGE
            localStorage.removeItem('loggedInUser');
            localStorage.removeItem('loggedInRole');

            alert('Anda telah berhasil keluar (logout).');
            currentUsername = null; 
            currentUserRole = null;
            showView('login-view');
            window.resetInput(); 
        }
        window.handleLogout = handleLogout;


        // ======================================
        // B. Logika Cek IP & History IP
        // ======================================
        
        function processData() {
            const rawData = document.getElementById('logInput').value;
            if (!rawData.trim()) {
                document.getElementById('results').innerHTML = "<p>‚ö†Ô∏è Harap tempelkan data terlebih dahulu.</p>";
                return;
            }
            const logData = parseRawData(rawData);
            const analysisResults = analyzeLoginData(logData);
            renderResults(analysisResults);
            
            saveHistory(rawData, analysisResults);
        }
        window.processData = processData;
        
        function parseRawData(rawData) {
            const lines = rawData.trim().split('\n');
            const parsedData = [];
            lines.forEach(line => {
                const parts = line.trim().split(/\s{2,}|\t/);
                if (parts.length >= 3) {
                    const userId = parts[0].trim();
                    let ipLogin = parts[2].trim(); 
                    if (userId && ipLogin && ipLogin.match(/^(\d{1,3}\.){3}\d{1,3}$/)) {
                        parsedData.push({ userId, ipLogin });
                    }
                }
            });
            return parsedData;
        }

        function analyzeLoginData(data) {
            const ipCounts = {};
            data.forEach(log => {
                const ip = log.ipLogin;
                ipCounts[ip] = (ipCounts[ip] || 0) + 1;
            });
            const resultsArray = Object.keys(ipCounts).map(ip => ({
                ipAddress: ip,
                userCount: ipCounts[ip]
            }));
            resultsArray.sort((a, b) => b.userCount - a.userCount);
            return resultsArray;
        }

        function renderResults(results) {
            const resultsDiv = document.getElementById('results');
            if (results.length === 0) {
                resultsDiv.innerHTML = "<p>Tidak ada data valid yang ditemukan setelah diproses. Harap cek kembali format data yang ditempelkan.</p>";
                return;
            }
            let html = `<h2>Hasil Analisis: ${results.length} IP Unik}</h2>`;
            html += `<p>Data diurutkan dari IP dengan User ID terbanyak. Status "CEK IP INI" jika hitungan >= **${THRESHOLD}**.</p>`;
            html += '<table>';
            html += '<thead><tr><th>IP Address</th><th>Total User ID Unik</th><th>Status</th></tr></thead>';
            html += '<tbody>';
            results.forEach(item => {
                const isHigh = item.userCount >= THRESHOLD;
                const rowClass = isHigh ? 'class="high-count"' : '';
                html += `<tr ${rowClass}>`;
                html += `<td>${item.ipAddress}</td>`;
                html += `<td>${item.userCount}</td>`;
                html += `<td>${isHigh ? '‚ùå CEK IP INI' : '‚úÖ NORMAL'}</td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';
            resultsDiv.innerHTML = html;
        }
        
        // --- LOGIKA HISTORY CEK IP ---
        
        function formatHistoryTimestamp(dateString) {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return dateString; 
            }
            
            const dateOptions = { 
                day: '2-digit', 
                month: 'long', 
                year: 'numeric'
            };
            
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');

            const formattedDate = date.toLocaleDateString('id-ID', dateOptions);
            const formattedTime = `${hours}:${minutes}:${seconds}`;
            
            return `${formattedDate}, ${formattedTime}`; 
        }

        function saveHistory(rawData, analysisResults) {
            const historyKey = 'ip_check_history';
            let history = JSON.parse(localStorage.getItem(historyKey) || '[]');

            const highCountIP = analysisResults.find(r => r.userCount >= THRESHOLD);
            const highIpInfo = highCountIP 
                ? `${highCountIP.ipAddress} (${highCountIP.userCount} user)` 
                : 'T/A';

            const newEntry = {
                timestamp: new Date().toISOString(), 
                username: currentUsername || 'UNKNOWN',
                uniqueIpCount: analysisResults.length,
                highIp: highIpInfo,
                rawData: rawData.substring(0, 200) + (rawData.length > 200 ? '...' : '')
            };

            history.unshift(newEntry); 

            if (history.length > 100) {
                history = history.slice(0, 100);
            }

            localStorage.setItem(historyKey, JSON.stringify(history));
        }

        function renderHistoryTable() {
            const historyKey = 'ip_check_history';
            const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            const tbody = document.getElementById('history-table').querySelector('tbody');
            
            tbody.innerHTML = ''; 

            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Belum ada riwayat pengecekan IP yang tercatat.</td></tr>';
                return;
            }

            history.forEach((entry, index) => {
                const formattedTime = formatHistoryTimestamp(entry.timestamp); 
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formattedTime}</td>
                    <td>${entry.username}</td>
                    <td>${entry.uniqueIpCount}</td>
                    <td>${entry.highIp}</td>
                    <td><div class="history-raw-data">${entry.rawData}</div></td>
                `;
            });
        }
        window.renderHistoryTable = renderHistoryTable;

        function clearHistory() {
            if (confirm("ANDA YAKIN INGIN MENGHAPUS SEMUA RIWAYAT CEK IP? Aksi ini tidak bisa dibatalkan!")) {
                const historyKey = 'ip_check_history';
                localStorage.removeItem(historyKey);
                alert("Semua riwayat pengecekan IP telah berhasil dihapus.");
                renderHistoryTable(); 
            }
        }
        window.clearHistory = clearHistory;
        // --- END LOGIKA HISTORY CEK IP ---


        // ======================================
        // C. Logika CEK TO CRM 
        // ======================================
        
        function processToData() {
            const rawData = document.getElementById('toInput').value;
            const lines = rawData.toUpperCase().trim().split('\n');
            const crmOutput = document.getElementById('crmOutput');

            if (lines.length === 0 || rawData.trim().length === 0) {
                crmOutput.textContent = "‚ö†Ô∏è Masukkan data log transaksi terlebih dahulu untuk diproses.";
                return;
            }

            let totalTO = 0;
            let foundLines = 0;

            // Regex yang sudah terbukti berhasil
            const betRegex = /PERTARUHAN\s*([\d\.,]+)/g; 

            const singleStringData = lines.join(' ');
            
            let match;
            while ((match = betRegex.exec(singleStringData)) !== null) {
                let amountString = match[1];
                
                // Bersihkan: Hapus semua koma (,) karena dianggap pemisah ribuan dalam data log Anda
                let cleanAmountString = amountString.replace(/,/g, ''); 
                
                let amount = parseFloat(cleanAmountString);

                if (!isNaN(amount) && amount > 0) {
                    totalTO += amount;
                    foundLines++;
                }
            }
            
            // Format menggunakan locale 'en-US' (Amerika) untuk koma ribuan (133,200)
            const formatter = new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0,
            });

            const formattedTotalTO = formatter.format(totalTO); 
            
            // Output
            let outputText = `Total Nominal Pertaruhan (TO) Ditemukan:\n\n`;
            outputText += `==========================================\n`;
            outputText += `  Total TO (Nominal): ${formattedTotalTO}\n`;
            outputText += `  (Dihitung dari ${foundLines} transaksi 'Pertaruhan')\n`;
            outputText += `==========================================`;

            crmOutput.textContent = outputText;
            alert(`‚úÖ Total TO berhasil dihitung: ${formattedTotalTO}`);
        }
        window.processToData = processToData;


        // ======================================
        // D. Logika HITUNG KEMENANGAN PG SOFT 
        // ======================================
        
        function processPgSoftData() {
            const rawData = document.getElementById('pgSoftInput').value;
            // Pisahkan data per baris
            const lines = rawData.toUpperCase().trim().split('\n').filter(l => l.trim().length > 0); 
            const pgSoftOutput = document.getElementById('pgSoftOutput');
            const netWinOutput = document.getElementById('netWinOutput');


            if (lines.length === 0) {
                pgSoftOutput.textContent = "‚ö†Ô∏è Masukkan data log transaksi PG Soft terlebih dahulu untuk diproses.";
                // Reset juga output net win
                netWinOutput.textContent = "Hasil Kemenangan Bersih akan tampil di sini (Pembayaran - Normal Spin).";
                lastTotalPayout = 0;
                return;
            }

            let totalPayout = 0;
            let foundPayouts = 0;
            
            // Regex mencari nominal di kolom payout (nominal kedua setelah 'Pembayaran')
            const payoutRegex = /PEMBAYARAN[\d\.,]+\s*([\d\.,]+)/; 

            lines.forEach(line => {
                if (line.includes('PEMBAYARAN')) {
                    const match = line.match(payoutRegex);
                    
                    if (match && match[1]) {
                        let amountString = match[1];
                        
                        // Bersihkan: Hapus semua koma (,) karena diasumsikan sebagai pemisah ribuan
                        let cleanAmountString = amountString.replace(/,/g, ''); 
                        
                        let amount = parseFloat(cleanAmountString);

                        if (!isNaN(amount) && amount > 0) {
                            totalPayout += amount;
                            foundPayouts++;
                        }
                    } else {
                        // Logika fallback untuk baris yang tidak sesuai format Regex di atas
                        const parts = line.split(/[^\d\.,]+/g).filter(p => p.trim().length > 0); 
                        // Ambil angka kedua dari belakang (sebelum saldo akhir)
                        if (parts.length >= 2) {
                            let nominalIndex = parts.length - 2; 
                            let amountString = parts[nominalIndex];
                            let cleanAmountString = amountString.replace(/,/g, ''); 
                            let amount = parseFloat(cleanAmountString);
                            
                            if (!isNaN(amount) && amount > 0) {
                                totalPayout += amount;
                                foundPayouts++;
                            }
                        }
                    }
                }
            });
            
            // Simpan hasil payout ke variabel global
            lastTotalPayout = totalPayout; 
            
            // Formatting helper function
            const formatter = new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0,
            });

            const formattedPayout = formatter.format(totalPayout);
            
            // Output
            let outputText = `Total Nominal Pembayaran PG SOFT Ditemukan:\n\n`;
            outputText += `==========================================\n`;
            outputText += `  Total Pembayaran (Win/Payout): ${formattedPayout}\n`;
            outputText += `  (Dihitung dari ${foundPayouts} baris 'Pembayaran')\n`;
            outputText += `==========================================\n\n`;

            pgSoftOutput.textContent = outputText;
            alert(`‚úÖ Total Pembayaran berhasil dihitung: ${formattedPayout}. Sekarang masukkan Nominal Normal Spin untuk menghitung Kemenangan Bersih.`);
            
            // Reset output Kemenangan Bersih saat data pembayaran baru diproses
            netWinOutput.textContent = "Hasil Kemenangan Bersih akan tampil di sini (Pembayaran - Normal Spin).";
        }
        window.processPgSoftData = processPgSoftData;
        
        
        function calculateNetWin() {
            const normalSpinInput = document.getElementById('normalSpinInput').value;
            const netWinOutput = document.getElementById('netWinOutput');
            
            if (lastTotalPayout === 0) {
                netWinOutput.textContent = "‚ö†Ô∏è ERROR: Harap proses data Pembayaran (Win/Payout) terlebih dahulu di kolom atas.";
                return;
            }
            
            if (!normalSpinInput.trim()) {
                netWinOutput.textContent = "‚ö†Ô∏è ERROR: Harap masukkan Nominal Total Normal Spin.";
                return;
            }

            // Bersihkan input Normal Spin dari koma (,) dan karakter non-angka lain kecuali titik (.)
            const cleanNormalSpinString = normalSpinInput.replace(/,/g, ''); 
            const totalNormalSpin = parseFloat(cleanNormalSpinString);

            if (isNaN(totalNormalSpin) || totalNormalSpin < 0) {
                netWinOutput.textContent = "‚ö†Ô∏è ERROR: Nominal Total Normal Spin tidak valid. Harap masukkan angka yang benar.";
                return;
            }
            
            // HITUNG KEMENANGAN BERSIH
            const totalNetWin = lastTotalPayout - totalNormalSpin;
            
            // Formatting helper function
            const formatter = new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0,
            });

            const formattedPayout = formatter.format(lastTotalPayout);
            const formattedNormalSpin = formatter.format(totalNormalSpin);
            const formattedNetWin = formatter.format(totalNetWin);
            
            // Tentukan status hasil
            let status = '';
            if (totalNetWin > 0) {
                status = `‚úÖ PROFIT!`;
            } else if (totalNetWin < 0) {
                status = `‚ùå RUGI!`;
            } else {
                status = `¬± IMPAS`;
            }

            // Output
            let outputText = `==========================================\n`;
            outputText += `  Total Pembayaran : ${formattedPayout}\n`;
            outputText += `  Total Normal Spin: ${formattedNormalSpin}\n`;
            outputText += `------------------------------------------\n`;
            outputText += `  KEMENANGAN BERSIH: ${formattedNetWin} (${status})\n`;
            outputText += `==========================================`;
            
            netWinOutput.textContent = outputText;
            alert(`‚úÖ Kemenangan Bersih berhasil dihitung: ${formattedNetWin}`);
        }
        window.calculateNetWin = calculateNetWin;


        // ======================================
        // E. Logika Prediksi Bola
        // ======================================

        function generateTable() {
            const input = document.getElementById('input').value.trim();
            const lines = input.split('\n').filter(l => l.trim() !== '');
            let outputHtmlContent = '';
            let leagueName = 'TIDAK DIKETAHUI';
            let leagueData = {};
            const matchRegex = /^(\d{2}\/\d{2})\s+(\d{2}:\d{2})\s+WIB\s+(.+?)\s+vs\s+(.+?)\s+(\d+\s*[:\-]\s*\d+)$/i;

            lines.forEach(line => {
                const match = line.match(matchRegex);
                if (match) {
                    const date = match[1];
                    const time = match[2];
                    const teamA = match[3].trim();
                    const teamB = match[4].trim();
                    const score = match[5].trim().replace(/\s*:\s*/g, ':').replace(/\s*-\s*/g, ':'); 
                    
                    if (!leagueData[leagueName]) leagueData[leagueName] = [];
                    leagueData[leagueName].push([
                        `${date} ${time} WIB`,
                        `${teamA} vs ${teamB}`,
                        score
                    ]);
                } else if (line.trim().length > 0) {
                    leagueName = line.trim().toUpperCase();
                    if (!leagueData[leagueName]) leagueData[leagueName] = [];
                }
            });

            for (const name in leagueData) {
                if (leagueData[name].length > 0) {
                    outputHtmlContent += `
                        <div class="match-block">
                          <h3 class="league-title">${name}</h3>
                          <table>
                            <thead>
                              <tr>
                                <th>Tanggal & Waktu</th>
                                <th>Pertandingan</th>
                                <th>Skor</th>
                              </tr>
                            </thead>
                            <tbody>
                    `;
                    leagueData[name].forEach(match => {
                        outputHtmlContent += `
                              <tr>
                                <td>${match[0]}</td>
                                <td>${match[1]}</td>
                                <td>${match[2]}</td>
                              </tr>
                        `;
                    });
                    outputHtmlContent += `</tbody></table></div>`;
                }
            }
            document.getElementById('output').innerHTML = outputHtmlContent;
            document.getElementById('htmlOutput').value = outputHtmlContent;
            alert('Tabel berhasil dibuat dan HTML telah di-generate!');
        }
        window.generateTable = generateTable;
        
        function copyHTML() {
            const html = document.getElementById('htmlOutput');
            if (html.value.trim() === '') {
                alert('Tidak ada HTML untuk disalin. Harap buat tabel terlebih dahulu.');
                return;
            }
            html.select();
            document.execCommand('copy');
            alert('Semua HTML berhasil disalin!');
        }
        window.copyHTML = copyHTML;


        // ======================================
        // F. Logika CRUD User & Approval 
        // ======================================
        
        function renderUserTable() {
            const tbody = document.getElementById('user-table').querySelector('tbody');
            tbody.innerHTML = ''; 
            
            // Data user diambil dari array global 'users' yang sudah diisi fetchUsers()

            users.forEach(user => {
                const row = tbody.insertRow();
                
                let statusText = user.status;
                let statusClass = '';
                let actionButtons = '';

                switch (user.status) {
                    case 'APPROVED':
                        statusClass = 'status-approved';
                        actionButtons = `<button class="btn-danger" style="width: auto; margin: 2px;" onclick="rejectUser('${user.username}')">Tolak</button>`;
                        break;
                    case 'PENDING':
                        statusClass = 'status-pending';
                        actionButtons = `<button class="btn-warning" style="width: auto; margin: 2px;" onclick="approveUser('${user.username}')">Setujui</button>`;
                        break;
                    case 'REJECTED':
                        statusClass = 'status-rejected';
                        actionButtons = `<button class="btn-warning" style="width: auto; margin: 2px;" onclick="approveUser('${user.username}')">Setujui</button>`;
                        break;
                    default:
                        statusText = 'UNKNOWN';
                        statusClass = '';
                        break;
                }

                // Tombol Edit dan Hapus
                actionButtons += `<button class="btn-primary" style="width: auto; background-color: orange; margin: 2px;" onclick="editUser('${user.username}')">Edit</button>
                                  <button class="btn-danger" style="width: auto; margin: 2px;" onclick="deleteUser('${user.username}')">Hapus</button>`;


                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td> 
                    <td class="${statusClass}">${statusText}</td>
                    <td>${actionButtons}</td>
                `;
            });
        }
        
        // Fungsi helper yang dimodifikasi untuk API
        async function updateUserStatusByUsername(username, newStatus) {
             const success = await updateUserOnSheetDB(username, { status: newStatus });
             if (success) {
                 alert(`Status user ${username} berhasil diubah menjadi ${newStatus}.`);
                 renderUserTable();
             }
        }

        async function approveUser(username) {
             await updateUserStatusByUsername(username, 'APPROVED');
        }
        window.approveUser = approveUser;

        async function rejectUser(username) {
             await updateUserStatusByUsername(username, 'REJECTED');
        }
        window.rejectUser = rejectUser;

        async function saveUser(event) {
            event.preventDefault(); 
            // Ambil username dari hidden field (untuk edit)
            const oldUsername = document.getElementById('user-username-hidden').value; 
            const newUsername = document.getElementById('user-username').value;
            const email = document.getElementById('user-email').value;
            const password = document.getElementById('user-password').value;
            const role = document.getElementById('user-role').value;

            if (oldUsername) {
                // LOGIKA UPDATE USER (PUT API)
                const updateData = {
                    username: newUsername, // Bisa ganti username
                    email: email,
                    role: role,
                };
                if (password) {
                    updateData.password = password;
                }
                
                const success = await updateUserOnSheetDB(oldUsername, updateData);
                
                if (success) {
                    alert(`User ${newUsername} berhasil diperbarui.`);
                    resetUserForm();
                    renderUserTable();
                }

            } else {
                // LOGIKA CREATE NEW USER (POST API)
                if (!password) {
                     alert('Gagal: Password wajib diisi untuk user baru.');
                     return;
                }
                
                // Cek duplikasi di array lokal (yang sudah di-fetch dari API)
                if (users.find(u => u.username === newUsername)) {
                    alert('Pendaftaran gagal. Username sudah digunakan.');
                    return;
                }

                const dataToSend = {
                    data: {
                        username: newUsername,
                        password: password,
                        email: email, 
                        role: role, 
                        status: 'APPROVED' // Jika dibuat oleh Master, status langsung APPROVED
                    }
                };

                try {
                    const response = await fetch(BASE_API_URL, {
                        method: 'POST', 
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(dataToSend)
                    });

                    if (response.ok) {
                        await fetchUsers();
                        alert(`User ${newUsername} berhasil ditambahkan.`);
                        resetUserForm();
                        renderUserTable();
                    } else {
                        alert('Gagal menambahkan user. Cek konfigurasi SheetDB.');
                    }
                } catch (error) {
                    console.error('Error Tambah User:', error);
                    alert('Koneksi server gagal saat menambah user.');
                }
            }
        }

        function editUser(username) {
            const user = users.find(u => u.username === username);
            if (user) {
                // Simpan username lama di hidden field
                document.getElementById('user-username-hidden').value = user.username;
                document.getElementById('user-username').value = user.username;
                document.getElementById('user-email').value = user.email;
                document.getElementById('user-role').value = user.role;
                document.getElementById('user-password').value = ''; 
                document.getElementById('submit-user-btn').textContent = 'Simpan Perubahan';
                document.getElementById('cancel-edit-btn').style.display = 'inline-block';
                document.getElementById('user-form').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        async function deleteUser(username) {
            const user = users.find(u => u.username === username);
            if (!user) return;

            if (confirm(`Apakah Anda yakin ingin menghapus user ${user.username}? Aksi ini tidak bisa dibatalkan!`)) {
                if (user.role === 'MASTER' && users.filter(u => u.role === 'MASTER').length <= 1) {
                    alert("Gagal: Harus ada minimal satu user MASTER.");
                    return;
                }
                
                try {
                    // Delete API: SheetDB menggunakan /username/:nilai
                    const deleteUrl = `${BASE_API_URL}/username/${username}`; 
                    
                    const response = await fetch(deleteUrl, {
                        method: 'DELETE',
                    });
                    
                    if (response.ok) {
                        alert(`User ${username} berhasil dihapus dari SheetDB.`);
                        await fetchUsers(); 
                        renderUserTable();
                    } else {
                        alert('Gagal menghapus user. Cek konfigurasi SheetDB.');
                    }
                } catch (error) {
                    console.error('Error Delete:', error);
                    alert('Koneksi server gagal saat menghapus user.');
                }
            }
        }

        function resetUserForm() {
            document.getElementById('user-username-hidden').value = '';
            document.getElementById('user-username').value = '';
            document.getElementById('user-email').value = '';
            document.getElementById('user-password').value = '';
            document.getElementById('user-role').value = 'CS';
            document.getElementById('submit-user-btn').textContent = 'Tambah User';
            document.getElementById('cancel-edit-btn').style.display = 'none';
        }

        window.renderUserTable = renderUserTable;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        window.resetUserForm = resetUserForm;

        // ======================================
        // G. Logika Login dan Register
        // ======================================

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // PENTING: Ambil data terbaru dari SheetDB sebelum mencari
            await fetchUsers(); 
            
            const user = users.find(u => u.username === username && u.password === password);

            if (!user) {
                alert('Login gagal! Username atau Password salah, atau akun belum terdaftar.');
                return;
            }
            
            // CEK STATUS USER
            if (user.status === 'PENDING') {
                alert('Login ditolak! Akun Anda masih berstatus PENDING (Menunggu Persetujuan Master).');
                return;
            }
            if (user.status === 'REJECTED') {
                 alert('Login ditolak! Akun Anda telah ditolak oleh Master.');
                 return;
            }
            
            // JIKA STATUS APPROVED
            currentUsername = user.username;
            currentUserRole = user.role;
            
            // SIMPAN SESSION KE LOCALSTORAGE
            localStorage.setItem('loggedInUser', currentUsername);
            localStorage.setItem('loggedInRole', currentUserRole);

            alert(`Login berhasil! Selamat datang, ${currentUsername} (${currentUserRole}).`);
            showView('dashboard-view');
            
            // SET DEFAULT VIEW BERDASARKAN ROLE
            let defaultContentId;
            let defaultMenuElement;

            if (user.role === 'KAPTEN') {
                defaultContentId = 'cek-to-crm';
                defaultMenuElement = document.getElementById('menu-cek-to-crm');
            } else {
                defaultContentId = 'cek-ip';
                defaultMenuElement = document.getElementById('menu-cek-ip');
            }
            
            switchDashboardContent(defaultContentId, defaultMenuElement);
        }

        async function handleRegister(event) {
            event.preventDefault();
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value; 

            // Pastikan data terbaru sudah di-fetch
            await fetchUsers(); 
            if (users.find(u => u.username === username)) {
                alert('Pendaftaran gagal. Username sudah digunakan.');
                return;
            }

            const dataToSend = {
                data: {
                    username: username,
                    password: password,
                    email: 'registered_without_email@default.com',
                    role: 'CS', // Default role untuk register
                    status: 'PENDING' // STATUS DEFAULT BARU UNTUK REGISTER
                }
            };

            try {
                const response = await fetch(BASE_API_URL, {
                    method: 'POST', 
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend)
                });

                if (response.ok) {
                    // Setelah berhasil register, muat ulang data user global
                    await fetchUsers(); 
                    alert(`Pendaftaran berhasil! Akun ${username} berhasil dibuat. Status: MENUNGGU ACC...`);
                    document.getElementById('register-form').reset();
                    showView('login-view');
                } else {
                    const errorData = await response.json().catch(() => ({ message: 'Terjadi kesalahan server.' }));
                    alert(`Pendaftaran gagal. ${errorData.message || 'Cek koneksi atau SheetDB Anda.'}`);
                }
            } catch (error) {
                console.error('Error Pendaftaran:', error);
                alert('Koneksi server gagal.');
            }
        }

        // ======================================
        // H. Inisialisasi Event Listener
        // ======================================

        document.addEventListener('DOMContentLoaded', async () => {
            // PENTING: Ambil data user dari SheetDB sebelum inisialisasi form login
            await fetchUsers(); 
            
            // BARU: Cek Sesi Tersimpan di localStorage
            const storedUser = localStorage.getItem('loggedInUser');
            const storedRole = localStorage.getItem('loggedInRole');

            if (storedUser && storedRole) {
                // Jika ada sesi tersimpan, langsung masuk ke Dashboard
                currentUsername = storedUser;
                currentUserRole = storedRole;
                showView('dashboard-view');
                
                // Atur tampilan default berdasarkan Role yang tersimpan
                let defaultContentId = (storedRole === 'KAPTEN') ? 'cek-to-crm' : 'cek-ip';
                let defaultMenuElement = document.getElementById(`menu-${defaultContentId}`);
                
                // Pastikan elemen defaultContentId ada sebelum memanggil switchDashboardContent
                if (defaultMenuElement) {
                   switchDashboardContent(defaultContentId, defaultMenuElement);
                }
                
                console.log(`Sesi dipulihkan untuk: ${storedUser} (${storedRole})`);
            } else {
                // Jika tidak ada sesi, tampilkan halaman login
                showView('login-view'); 
            }
            
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('user-form').addEventListener('submit', saveUser);
            
            window.resetInput = function() {
                document.getElementById('logInput').value = '';
                document.getElementById('results').innerHTML = '<p>Tempelkan data Anda dan tekan "Klik Disini".</p>';
            };
            document.addEventListener('keydown', (e) => {
                if (e.key === 'F5' && document.getElementById('dashboard-view').style.display === 'flex') {
                    e.preventDefault();
                    window.resetInput();
                }
            });
            
        });
        
    </script>

</body>
</html>
